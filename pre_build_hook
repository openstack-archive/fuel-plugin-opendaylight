#!/bin/bash

# Add here any the actions which are required before plugin build
# like packages building, packages downloading from mirrors and so on.
# The script should return 0 if there were no errors.
set -eux

# Where we can find odl karaf distribution tarball
# can be http(s) url or absolute path
ODL_TARBALL_LOCATION=${ODL_TARBALL_LOCATION:-https://nexus.opendaylight.org/content/groups/public/org/opendaylight/integration/distribution-karaf/0.3.1-Lithium-SR1/distribution-karaf-0.3.1-Lithium-SR1.tar.gz}

#Verion number used in deb/rpm package
ODL_VERSION_NUMBER=${ODL_VERSION_NUMBER:-0.3.1}
ODL_DESCRIPTION="OpenDaylight SDN Controller"
TMP_NAME="karaf-odl.tar.gz"

OVS_VERSION="2.3.2"

# For which systems odl package should be build
BUILD_FOR=${BUILD_FOR:-centos ubuntu}

DIR="$(dirname `readlink -f $0`)"
MODULES="${DIR}/deployment_scripts/puppet/modules"

# If true java and it dependencies will be part of the plugin.
# Useful for offline deployments.
INCLUDE_DEPENDENCIES=${INCLUDE_DEPENDENCIES:-false}

# Patch ODL to use br-floating as external bridge
USE_FUEL_PATCH=${USE_FUEL_PATCH:-true}

function cleanup {
  rm -f "${DIR}/${TMP_NAME}"
  rm -rf "${DIR}/package"
}

function download {
  wget "$1" -qO $2
}

function unpack {
  tar xzf $1 --strip-components=1 -C "${DIR}/package"
}

function patch_odl {
  cp "${DIR}/odl_package/odl_lithium_patch/openstack.net-virt-1.1.1-Lithium-SR1.jar" "${DIR}/package/system/org/opendaylight/ovsdb/openstack.net-virt/1.1.1-Lithium-SR1/openstack.net-virt-1.1.1-Lithium-SR1.jar"
}

# Download packages required by ODL.
# List generated with commands:
#   yumdownloader --urls --resolve java-1.7.0-openjdk
#   apt-get --print-uris --yes install openjdk-7-jre-headless | grep ^\' | cut -d\' -f2 >downloads.list
function download_dependencies {
  if [ "$INCLUDE_DEPENDENCIES" = true ]
  then
    wget -N -i "${DIR}/odl_package/${1}/dependencies.txt"
  fi
}

function build_pkg {
  case $1 in
    centos)
      pushd "${DIR}/repositories/${1}/"
      fpm --force -s dir -t rpm --version "${ODL_VERSION_NUMBER}" --description "${ODL_DESCRIPTION}" --prefix /opt/opendaylight --rpm-init "${DIR}/odl_package/${1}/opendaylight" --after-install "${DIR}/odl_package/${1}/opendaylight-post" --name opendaylight -d "java-1.7.0-openjdk" -C "${DIR}/package"
      download_dependencies ${1}
      popd
      sudo yum install redhat-rpm-config rpm-build openssl-devel wget kernel-devel gcc -y
      sudo yum groupinstall "Development Tools"
      wget http://openvswitch.org/releases/openvswitch-${OVS_VERSION}.tar.gz
      tar xfz openvswitch-${OVS_VERSION}.tar.gz
      mkdir -p ~/rpmbuild/SOURCES
      cp openvswitch-${OVS_VERSION}.tar.gz rpmbuild/SOURCES
      cd openvswitch-${OVS_VERSION}
      cp rhel/openvswitch-kmod.files ~/rpmbuild/SOURCES/
      sudo rpmbuild -bb rhel/openvswitch-kmod-rhel6.spec
      sudo rpmbuild -bb rhel/openvswitch.spec
      mv ~/rpmbuild/RPMS/x86_64/*.rpm ${DIR}/repositories/centos/
      ;;
    ubuntu)
      pushd "${DIR}/repositories/${1}/"
      fpm --force -s dir -t deb --version "${ODL_VERSION_NUMBER}" --description "${ODL_DESCRIPTION}" --prefix /opt/opendaylight --deb-upstart "${DIR}/odl_package/${1}/opendaylight" --after-install "${DIR}/odl_package/${1}/opendaylight-post" --name opendaylight -d "openjdk-7-jre-headless" -C "${DIR}/package"
      download_dependencies ${1}
      popd
      sudo apt-get install build-essential fakeroot debhelper libssl-dev -y
      wget http://openvswitch.org/releases/openvswitch-${OVS_VERSION}.tar.gz
      tar -xzf openvswitch-${OVS_VERSION}.tar.gz
      cd openvswitch-${OVS_VERSION}
      DEB_BUILD_OPTIONS='parallel=8 nocheck' fakeroot debian/rules binary
      cd ..
      mv openvswitch*.deb ${DIR}/repositories/ubuntu/
      ;;
    *) echo "Not supported system"; exit 1;;
  esac
}

command -v fpm >/dev/null 2>&1 || { echo >&2 "fpm ruby gem required but it's not installed.  Aborting."; exit 1; }

cleanup

mkdir -p "${DIR}/package"

if [[ "$ODL_TARBALL_LOCATION" =~ ^http.* ]]
then
  download $ODL_TARBALL_LOCATION ${DIR}/${TMP_NAME}
  unpack ${DIR}/${TMP_NAME}
else
  unpack $ODL_TARBALL_LOCATION
fi

if [ "$USE_FUEL_PATCH" = true ]
then
  patch_odl
fi

for system in $BUILD_FOR
do
  build_pkg $system
done

cleanup
